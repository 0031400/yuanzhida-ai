<navigation-bar title="我的" back="{{false}}" color="black" background="#FFF"></navigation-bar>

<view class="page">
  <view wx:if="{{!isLoggedIn}}" class="card guest-card">
    <view class="guest-hero">
      <view class="guest-avatar">
        <text class="guest-avatar-text">A</text>
      </view>
      <view class="guest-headline">
        <text class="guest-title">登录后解锁完整个人主页</text>
        <text class="guest-desc">管理提问、评论和收藏，及时查看互动消息</text>
      </view>
    </view>

    <view class="guest-feature-row">
      <view class="guest-feature">
        <text class="guest-feature-value">提问</text>
        <text class="guest-feature-label">沉淀学习记录</text>
      </view>
      <view class="guest-feature">
        <text class="guest-feature-value">评论</text>
        <text class="guest-feature-label">追踪回复动态</text>
      </view>
      <view class="guest-feature">
        <text class="guest-feature-value">收藏</text>
        <text class="guest-feature-label">整理重点内容</text>
      </view>
    </view>

    <view class="guest-action-row">
      <van-button type="primary" round custom-class="guest-login-btn" bindtap="onLoginTap">去登录</van-button>
      <view class="guest-action-link" bindtap="onOpenResetPwdEditor">忘记密码？去重置</view>
    </view>
  </view>

  <view wx:elif="{{loading}}" class="card">
    <view class="skeleton-line title"></view>
    <view class="skeleton-line"></view>
    <view class="skeleton-line short"></view>
  </view>

  <block wx:else>
    <view class="card profile-card">
      <view class="profile-main">
        <view class="avatar-wrap">
          <image wx:if="{{profile && profile.avatar}}" class="avatar" src="{{profile.avatar}}" mode="aspectFill" />
          <view wx:else class="avatar avatar-fallback">
            <text class="avatar-text">{{(profile && profile.username) ? profile.username.slice(0, 1).toUpperCase() : '我'}}</text>
          </view>
        </view>
        <view class="profile-meta">
          <text class="username">{{profile.username}}</text>
          <view class="intro-row">
            <text class="introduction">{{profile.introduction || '这个同学很神秘，暂时没有简介。'}}</text>
            <text class="edit-intro-btn" bindtap="onEditIntroductionTap">编辑简介</text>
          </view>
        </view>
      </view>
      <view class="stats-row">
        <view class="stat-item" wx:for="{{stats}}" wx:key="label">
          <text class="stat-value">{{item.value}}</text>
          <text class="stat-label">{{item.label}}</text>
        </view>
      </view>
    </view>

    <view class="card menu-card">
      <view class="menu-item" data-key="message" bindtap="onMenuTap">
        <text class="menu-title">消息中心</text>
        <view class="menu-right">
          <view wx:if="{{unreadCount > 0}}" class="badge">{{unreadCount}}</view>
          <text class="arrow">></text>
        </view>
      </view>
      <view class="menu-item" data-key="my-question" bindtap="onMenuTap">
        <text class="menu-title">我的提问</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item" data-key="my-comment" bindtap="onMenuTap">
        <text class="menu-title">我的评论</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item" data-key="my-collect" bindtap="onMenuTap">
        <text class="menu-title">我的收藏</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item" data-key="my-recent" bindtap="onMenuTap">
        <text class="menu-title">最近浏览</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item" data-key="reset-password" bindtap="onMenuTap">
        <text class="menu-title">重置密码</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item danger" data-key="logout" bindtap="onMenuTap">
        <text class="menu-title">退出登录</text>
        <text class="arrow">></text>
      </view>
    </view>
  </block>

  <view class="safe-bottom"></view>

  <view wx:if="{{showIntroEditor}}" class="intro-popup-mask" catchtap="onCloseIntroEditor">
    <view class="intro-popup" catchtap="onIntroEditorPanelTap">
      <view class="intro-popup-head">
        <text class="intro-popup-title">编辑简介</text>
        <text class="intro-popup-close" bindtap="onCloseIntroEditor">关闭</text>
      </view>
      <textarea
        class="intro-input"
        maxlength="80"
        value="{{introDraft}}"
        bindinput="onIntroductionInput"
        placeholder="写点关于你自己的介绍..."
        show-confirm-bar="{{false}}"
        auto-height="{{true}}"
      />
      <view class="intro-count">{{introDraft.length}} / 80</view>
      <view class="intro-popup-actions">
        <view class="intro-btn cancel {{introSubmitting ? 'disabled' : ''}}" bindtap="onCloseIntroEditor">取消</view>
        <view class="intro-btn confirm {{introSubmitting ? 'disabled' : ''}}" bindtap="onSubmitIntroduction">
          {{introSubmitting ? '保存中...' : '保存'}}
        </view>
      </view>
    </view>
  </view>

  <view wx:if="{{showResetPwdEditor}}" class="intro-popup-mask" catchtap="onCloseResetPwdEditor">
    <view class="intro-popup" catchtap="onResetPwdPanelTap">
      <view class="intro-popup-head">
        <text class="intro-popup-title">重置密码</text>
        <text class="intro-popup-close" bindtap="onCloseResetPwdEditor">关闭</text>
      </view>
      <input
        class="pwd-input"
        type="text"
        value="{{resetUsername}}"
        placeholder="请输入用户名"
        bindinput="onResetUsernameInput"
      />
      <input
        class="pwd-input"
        type="text"
        value="{{resetMail}}"
        placeholder="请输入注册邮箱"
        bindinput="onResetMailInput"
      />
      <view class="code-row">
        <input
          class="pwd-input code-input"
          type="text"
          value="{{resetCode}}"
          placeholder="请输入验证码"
          bindinput="onResetCodeInput"
        />
        <view class="code-btn {{(resetSendingCode || resetCountdown > 0) ? 'disabled' : ''}}" bindtap="onSendResetCode">
          {{resetCountdown > 0 ? (resetCountdown + 's') : (resetSendingCode ? '发送中...' : '发送验证码')}}
        </view>
      </view>
      <input
        class="pwd-input"
        password="{{true}}"
        value="{{resetPassword}}"
        placeholder="请输入新密码（至少6位）"
        bindinput="onResetPasswordInput"
      />
      <input
        class="pwd-input"
        password="{{true}}"
        value="{{resetConfirmPassword}}"
        placeholder="请再次输入新密码"
        bindinput="onResetConfirmPasswordInput"
      />
      <view class="intro-popup-actions">
        <view class="intro-btn cancel {{resetSubmitting ? 'disabled' : ''}}" bindtap="onCloseResetPwdEditor">取消</view>
        <view class="intro-btn confirm {{resetSubmitting ? 'disabled' : ''}}" bindtap="onSubmitResetPassword">
          {{resetSubmitting ? '提交中...' : '确认重置'}}
        </view>
      </view>
    </view>
  </view>
</view>
