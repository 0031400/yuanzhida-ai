<navigation-bar title="我的" back="{{false}}" color="black" background="#FFF"></navigation-bar>

<view class="page">
  <view wx:if="{{!isLoggedIn}}" class="card guest-card">
    <text class="guest-title">登录后查看个人主页</text>
    <text class="guest-desc">查看个人数据、收藏记录和消息通知</text>
    <van-button type="primary" round bindtap="onLoginTap">去登录</van-button>
  </view>

  <view wx:elif="{{loading}}" class="card">
    <view class="skeleton-line title"></view>
    <view class="skeleton-line"></view>
    <view class="skeleton-line short"></view>
  </view>

  <block wx:else>
    <view class="card profile-card">
      <view class="profile-main">
        <view class="avatar-wrap">
          <image wx:if="{{profile && profile.avatar}}" class="avatar" src="{{profile.avatar}}" mode="aspectFill" />
          <view wx:else class="avatar avatar-fallback">
            <text class="avatar-text">{{(profile && profile.username) ? profile.username.slice(0, 1).toUpperCase() : '我'}}</text>
          </view>
        </view>
        <view class="profile-meta">
          <text class="username">{{profile.username}}</text>
          <view class="intro-row">
            <text class="introduction">{{profile.introduction || '这个同学很神秘，暂时没有简介。'}}</text>
            <text class="edit-intro-btn" bindtap="onEditIntroductionTap">编辑简介</text>
          </view>
        </view>
      </view>
      <view class="stats-row">
        <view class="stat-item" wx:for="{{stats}}" wx:key="label">
          <text class="stat-value">{{item.value}}</text>
          <text class="stat-label">{{item.label}}</text>
        </view>
      </view>
    </view>

    <view class="card menu-card">
      <view class="menu-item" data-key="message" bindtap="onMenuTap">
        <text class="menu-title">消息中心</text>
        <view class="menu-right">
          <view wx:if="{{unreadCount > 0}}" class="badge">{{unreadCount}}</view>
          <text class="arrow">></text>
        </view>
      </view>
      <view class="menu-item" data-key="my-question" bindtap="onMenuTap">
        <text class="menu-title">我的提问</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item" data-key="my-comment" bindtap="onMenuTap">
        <text class="menu-title">我的评论</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item" data-key="my-collect" bindtap="onMenuTap">
        <text class="menu-title">我的收藏</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item" data-key="my-recent" bindtap="onMenuTap">
        <text class="menu-title">最近浏览</text>
        <text class="arrow">></text>
      </view>
      <view class="menu-item danger" data-key="logout" bindtap="onMenuTap">
        <text class="menu-title">退出登录</text>
        <text class="arrow">></text>
      </view>
    </view>
  </block>

  <view class="safe-bottom"></view>

  <view wx:if="{{showIntroEditor}}" class="intro-popup-mask" catchtap="onCloseIntroEditor">
    <view class="intro-popup" catchtap="onIntroEditorPanelTap">
      <view class="intro-popup-head">
        <text class="intro-popup-title">编辑简介</text>
        <text class="intro-popup-close" bindtap="onCloseIntroEditor">关闭</text>
      </view>
      <textarea
        class="intro-input"
        maxlength="80"
        value="{{introDraft}}"
        bindinput="onIntroductionInput"
        placeholder="写点关于你自己的介绍..."
        show-confirm-bar="{{false}}"
        auto-height="{{true}}"
      />
      <view class="intro-count">{{introDraft.length}} / 80</view>
      <view class="intro-popup-actions">
        <view class="intro-btn cancel {{introSubmitting ? 'disabled' : ''}}" bindtap="onCloseIntroEditor">取消</view>
        <view class="intro-btn confirm {{introSubmitting ? 'disabled' : ''}}" bindtap="onSubmitIntroduction">
          {{introSubmitting ? '保存中...' : '保存'}}
        </view>
      </view>
    </view>
  </view>
</view>
