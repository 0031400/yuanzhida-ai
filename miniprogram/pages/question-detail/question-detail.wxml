<navigation-bar title="问题详情" back="{{true}}" color="black" background="#fff"></navigation-bar>

<view class="page">
  <scroll-view class="scroll" scroll-y="{{true}}" bindscrolltolower="onReachBottom">
    <block wx:if="{{loading}}">
      <view class="skeleton-card">
        <view class="skeleton-line title"></view>
        <view class="skeleton-line"></view>
        <view class="skeleton-line short"></view>
      </view>
    </block>

    <block wx:elif="{{!question}}">
      <van-empty description="题目不存在或已被删除" />
    </block>

    <block wx:else>
      <view class="question-card">
        <text class="title">{{question.title}}</text>
        <text class="content">{{question.content}}</text>
        <view class="meta-row">
          <text class="meta">作者：{{question.username}}</text>
          <text class="meta">{{questionTimeText}}</text>
          <text class="meta">赞 {{question.likeCount}}</text>
          <text class="meta">评 {{question.commentCount}}</text>
        </view>
        <view class="question-action-row">
          <text class="solve-tag {{question.solvedFlag === 1 ? 'resolved' : 'pending'}}">
            {{question.solvedFlag === 1 ? '已解决' : '待解决'}}
          </text>
          <van-button
            wx:if="{{canResolveQuestion}}"
            custom-class="resolve-btn"
            type="primary"
            size="small"
            loading="{{resolvingQuestion}}"
            bind:tap="onMarkResolved"
          >
            {{question.solvedFlag === 1 ? '取消已解决' : '标记已解决'}}
          </van-button>
        </view>

        <view class="image-grid" wx:if="{{imageList.length > 0}}">
          <image
            wx:for="{{imageList}}"
            wx:key="*this"
            class="question-image"
            src="{{item}}"
            mode="aspectFill"
            data-index="{{index}}"
            bindtap="onPreviewImage"
          />
        </view>
      </view>

      <view class="section-title">评论</view>

      <block wx:if="{{comments.length === 0}}">
        <view class="comment-empty">
          <van-empty description="暂无评论，来抢沙发吧" />
        </view>
      </block>

      <block wx:else>
        <view class="comment-card" wx:for="{{comments}}" wx:key="id" wx:for-item="comment" wx:for-index="commentIndex">
          <view class="comment-head">
            <text class="comment-user">{{comment.username}}</text>
            <text class="comment-time">{{comment.createTimeText}}</text>
          </view>
          <text class="comment-content">{{comment.content}}</text>
          <view class="comment-image-grid" wx:if="{{comment.imageList.length > 0}}">
            <image
              wx:for="{{comment.imageList}}"
              wx:key="*this"
              wx:for-item="image"
              wx:for-index="imageIndex"
              class="comment-image"
              src="{{image}}"
              mode="aspectFill"
              data-comment-index="{{commentIndex}}"
              data-image-index="{{imageIndex}}"
              bindtap="onPreviewCommentImage"
            />
          </view>
          <view class="comment-meta">
            <text class="comment-like">点赞 {{comment.likeCount}}</text>
            <view class="comment-action-group">
              <text
                class="comment-reply-btn"
                data-id="{{comment.id}}"
                data-username="{{comment.username}}"
                bindtap="onLikeComment"
              >
                点赞
              </text>
              <text
                class="comment-reply-btn"
                data-id="{{comment.id}}"
                data-username="{{comment.username}}"
                bindtap="onReplyTopComment"
              >
                回复
              </text>
              <text
                wx:if="{{comment.isMine}}"
                class="comment-reply-btn danger"
                data-id="{{comment.id}}"
                data-username="{{comment.username}}"
                data-has-children="{{comment.childCards.length > 0}}"
                bindtap="onDeleteComment"
              >
                删除
              </text>
            </view>
          </view>

          <view class="child-comment-list" wx:if="{{comment.childCards.length > 0}}">
            <view
              class="child-comment-item"
              wx:for="{{comment.childCards}}"
              wx:key="id"
              wx:for-item="child"
              wx:for-index="childIndex"
            >
              <view class="comment-head">
                <text class="comment-user">{{child.username}}</text>
                <text class="comment-time">{{child.createTimeText}}</text>
              </view>
              <text class="comment-content" wx:if="{{child.commentTo && child.commentTo.length > 0}}">
                回复 {{child.commentTo}}：{{child.content}}
              </text>
              <text class="comment-content" wx:else>{{child.content}}</text>
              <view class="comment-image-grid" wx:if="{{child.imageList.length > 0}}">
                <image
                  wx:for="{{child.imageList}}"
                  wx:key="*this"
                  wx:for-item="childImage"
                  wx:for-index="childImageIndex"
                  class="comment-image"
                  src="{{childImage}}"
                  mode="aspectFill"
                  data-top-index="{{commentIndex}}"
                  data-child-index="{{childIndex}}"
                  data-image-index="{{childImageIndex}}"
                  bindtap="onPreviewChildCommentImage"
                />
              </view>
              <view class="comment-meta">
                <text class="comment-like">点赞 {{child.likeCount}}</text>
                <view class="comment-action-group">
                  <text
                    class="comment-reply-btn"
                    data-id="{{child.id}}"
                    data-username="{{child.username}}"
                    bindtap="onLikeComment"
                  >
                    点赞
                  </text>
                  <text
                    class="comment-reply-btn"
                    data-top-id="{{comment.id}}"
                    data-username="{{child.username}}"
                    bindtap="onReplyChildComment"
                  >
                    回复
                  </text>
                  <text
                    wx:if="{{child.isMine}}"
                    class="comment-reply-btn danger"
                    data-id="{{child.id}}"
                    data-username="{{child.username}}"
                    data-has-children="{{false}}"
                    bindtap="onDeleteComment"
                  >
                    删除
                  </text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>

      <view class="footer">
        <text wx:if="{{commentLoadingMore}}" class="footer-text">评论加载中...</text>
        <text wx:elif="{{!hasMoreComments && comments.length > 0}}" class="footer-text">评论到底了</text>
      </view>
    </block>
  </scroll-view>

  <view class="comment-bar">
    <view class="reply-indicator" wx:if="{{replyParentCommentId > 0}}">
      <text class="reply-indicator-text">正在回复：{{replyToUsername}}</text>
      <text class="reply-indicator-cancel" bindtap="onCancelReply">取消</text>
    </view>
    <view class="draft-image-grid" wx:if="{{commentImagePaths.length > 0}}">
      <view wx:for="{{commentImagePaths}}" wx:key="*this" class="draft-image-item">
        <image
          class="draft-image"
          src="{{item}}"
          mode="aspectFill"
          data-index="{{index}}"
          bindtap="onPreviewCommentDraftImage"
        />
        <view class="draft-image-remove" data-index="{{index}}" bindtap="onRemoveCommentImage">×</view>
      </view>
    </view>
    <view class="comment-actions">
      <view class="pick-image-btn" bindtap="onChooseCommentImages">+ 图片</view>
      <text class="pick-image-tip">{{commentImagePaths.length}} / 3</text>
    </view>
    <view class="comment-input-row">
      <textarea
        class="comment-input"
        maxlength="1000"
        placeholder="写下评论，可带图片..."
        value="{{commentDraft}}"
        bindinput="onCommentInput"
        auto-height="{{true}}"
        show-confirm-bar="{{false}}"
      />
      <view class="comment-send-row">
        <van-button
          custom-class="comment-send-btn"
          type="primary"
          size="small"
          loading="{{submittingComment}}"
          bind:tap="onSubmitComment"
        >
          发送
        </van-button>
      </view>
    </view>
  </view>
</view>
