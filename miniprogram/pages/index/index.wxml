<navigation-bar title="Answerly 问答" back="{{false}}" color="black" background="#FFF"></navigation-bar>

<view class="page">
  <view class="search-wrap">
    <van-search
      model:value="{{keyword}}"
      shape="round"
      placeholder="搜索课程问题关键词"
      bind:change="onKeywordInput"
      bind:search="onSearchConfirm"
      bind:clear="onSearchClear"
    />
    <view wx:if="{{showSuggestions}}" class="suggest-panel">
      <view
        class="suggest-item"
        wx:for="{{suggestions}}"
        wx:key="*this"
        data-keyword="{{item}}"
        bindtap="onSuggestionTap"
      >
        {{item}}
      </view>
    </view>
  </view>

  <scroll-view class="category-scroll" scroll-x="{{true}}" enable-flex="{{true}}" show-scrollbar="{{false}}">
    <view class="category-row">
      <view
        class="category-chip {{activeCategoryId === 0 ? 'active' : ''}}"
        data-id="0"
        bindtap="onCategoryTap"
      >
        全部
      </view>
      <view
        wx:for="{{categories}}"
        wx:key="id"
        class="category-chip {{activeCategoryId === item.id ? 'active' : ''}}"
        data-id="{{item.id}}"
        bindtap="onCategoryTap"
      >
        {{item.name}}
      </view>
    </view>
  </scroll-view>

  <scroll-view
    class="question-scroll"
    scroll-y="{{true}}"
    lower-threshold="{{120}}"
    bindscrolltolower="onScrollToLower"
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onRefresherRefresh"
  >
    <view class="content">
      <block wx:if="{{loading}}">
        <view class="skeleton-card" wx:for="{{[1,2,3]}}" wx:key="*this">
          <view class="skeleton-line title"></view>
          <view class="skeleton-line"></view>
          <view class="skeleton-line short"></view>
        </view>
      </block>

      <block wx:elif="{{questions.length === 0}}">
        <van-empty description="这个主题还没有问题，试试发布第一条吧" />
      </block>

      <block wx:else>
        <view
          class="question-card"
          wx:for="{{questions}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="onQuestionTap"
        >
          <view class="card-head">
            <text class="status-tag {{item.solvedFlag === 1 ? 'resolved' : 'pending'}}">{{item.solvedText}}</text>
          </view>
          <rich-text class="title rich-block" nodes="{{item.titleRich}}" />
          <rich-text class="question-content rich-block" nodes="{{item.contentRich}}" />
          <view class="meta-row">
            <text class="meta user-link" data-username="{{item.username}}" catchtap="onUserTap">{{item.username}}</text>
            <text class="meta">{{item.createTimeText}}</text>
            <text class="meta">赞 {{item.likeCount}}</text>
            <text class="meta">评 {{item.commentCount}}</text>
          </view>
        </view>

        <view class="list-footer">
          <text wx:if="{{loadingMore}}" class="footer-text">加载中...</text>
          <text wx:elif="{{!hasMore}}" class="footer-text">没有更多了</text>
        </view>
      </block>
    </view>
  </scroll-view>

  <view class="ask-fab" bindtap="onAskTap" hover-class="ask-fab-hover">
    <view class="ask-fab-icon">+</view>
    <text class="ask-fab-text">提问</text>
  </view>

  <view wx:if="{{showUserPopup}}" class="user-popup-mask" catchtap="onCloseUserPopup">
    <view class="user-popup" catchtap="onUserPopupPanelTap">
      <view class="user-popup-head">
        <text class="user-popup-title">用户信息</text>
        <text class="user-popup-close" bindtap="onCloseUserPopup">关闭</text>
      </view>
      <view wx:if="{{userPopupLoading}}" class="user-popup-loading">加载中...</view>
      <view wx:elif="{{userPopupProfile}}" class="user-popup-body">
        <view class="user-popup-avatar-wrap">
          <image
            wx:if="{{userPopupProfile.avatar}}"
            class="user-popup-avatar"
            src="{{userPopupProfile.avatar}}"
            mode="aspectFill"
          />
          <view wx:else class="user-popup-avatar user-popup-avatar-fallback">
            <text>{{userPopupProfile.username.slice(0, 1).toUpperCase()}}</text>
          </view>
        </view>
        <text class="user-popup-name">{{userPopupProfile.username}}</text>
        <text wx:if="{{userPopupProfile.userType}}" class="user-popup-type">{{userPopupProfile.userType}}</text>
        <text class="user-popup-intro">{{userPopupProfile.introduction || '这个用户暂未填写简介。'}}</text>
        <view class="user-popup-stats">
          <view class="user-popup-stat-item">
            <text class="user-popup-stat-value">{{userPopupProfile.likeCount || 0}}</text>
            <text class="user-popup-stat-label">获赞</text>
          </view>
          <view class="user-popup-stat-item">
            <text class="user-popup-stat-value">{{userPopupProfile.collectCount || 0}}</text>
            <text class="user-popup-stat-label">收藏</text>
          </view>
          <view class="user-popup-stat-item">
            <text class="user-popup-stat-value">{{userPopupProfile.usefulCount || 0}}</text>
            <text class="user-popup-stat-label">有用</text>
          </view>
          <view class="user-popup-stat-item">
            <text class="user-popup-stat-value">{{userPopupProfile.solvedCount || 0}}</text>
            <text class="user-popup-stat-label">解决</text>
          </view>
        </view>
      </view>
      <view wx:if="{{userPopupError}}" class="user-popup-error">{{userPopupError}}</view>
    </view>
  </view>
</view>
